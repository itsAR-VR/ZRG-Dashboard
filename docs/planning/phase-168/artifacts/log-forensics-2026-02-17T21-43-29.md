# Log Forensics — `zrg-dashboard-log-export-2026-02-17T21-43-29.json`

## Dataset Summary
- File: `zrg-dashboard-log-export-2026-02-17T21-43-29.json`
- Size: ~34 MB
- Rows: `39,385`
- Deployment ID for all rows: `dpl_H5eNbGu6SeiTpeJtvwQsLrpFZERz`

## HTTP Status Breakdown
- `504`: `30,468`
- `500`: `6,077`
- `200`: `1,037`

## Highest-Frequency Failing Routes
- `21,050` — `/api/webhooks/email`
- `13,656` — `/api/inbox/conversations`
- `545` — `/api/cron/response-timing`
- `194` — `/api/cron/appointment-reconcile`
- `190` — `/api/cron/emailbison/availability-slot`
- `165` — `/api/cron/followups`
- `156` — `/api/cron/availability`
- `147` — `/api/inbox/counts`

## Error Signature Totals
- `Task timed out after 60 seconds`: `5,063`
- `Task timed out after 300 seconds`: `3,289`
- `query_wait_timeout`: `419`
- `P2028` (Prisma transaction API): `1,794`
- `Unable to start a transaction in the given time`: `400`
- Expired transaction (`A query cannot be executed on an expired transaction`): `126`
- `P2010` raw query errors: `60`
- `client_login_timeout`: `37`

## Correlation Findings
- Timeout request IDs with webhook event context:
  - `4,867` timed-out requests were `EMAIL_SENT`
  - `56` were `EMAIL_BOUNCED`
  - `53` were `LEAD_REPLIED`
- Dominant 60s timeout route/signature pair:
  - `4,985` — `timeout_60s` on `/api/webhooks/email`
- Dominant 300s timeout route/signature pair:
  - `3,202` — `timeout_300s` on `/api/inbox/conversations`

## Runtime Duration Evidence (from `durationMs`)
- `/api/webhooks/email`: count `9,978`, p50 `562ms`, p95 `60,001ms`, p99 `60,002ms`
- `/api/inbox/conversations`: count `10,067`, p50 `2,194ms`, p95 `300,001ms`, p99 `300,001ms`
- `/api/cron/response-timing`: count `421`, p50 `5,047ms`, p95 `13,677ms`, p99 `17,618ms`
- `/api/inbox/counts`: count `130`, p50 `10ms`, p95 `300,001ms`, p99 `300,002ms`

## Root Cause Matrix

| Issue Class | Evidence | Root Cause | Confidence | Fix Strategy |
|---|---|---|---|---|
| Webhook 60s timeouts | 4,985 on `/api/webhooks/email`; 4,867 timeout IDs tagged `EMAIL_SENT` | High-volume `EMAIL_SENT` path still running synchronous DB-heavy work during bursts; async queue mode likely not active in prod | High | Enable queue-first webhook handling in production (`INBOXXIA_EMAIL_SENT_ASYNC=true`), keep dedupe on enqueue key, deploy timeout-hardening branch |
| Inbox 300s timeouts + transaction errors | 3,202 `timeout_300s` + 1,267 `P2028` + 392 transaction-start timeout on `/api/inbox/conversations` | Read path under DB contention; long-running scans plus transaction start contention produce 300s route timeouts | High | Deploy latest inbox query guardrails, reduce expensive search paths, keep/expand DB statement timeout controls, verify p95 via `x-zrg-duration-ms` |
| Response-timing cron 500s | 545 `500` on `/api/cron/response-timing`; 126 expired transactions near 5s | Processor does multi-step work inside one interactive transaction in deployed version; transaction envelope expires before completion | High | Deploy updated processor timeout envelope/batch handling; split work into smaller units if needed; verify zero new `P2028` in next windows |
| Broad `query_wait_timeout` across cron + app routes | 419 query_wait errors across conversations/counts/home and multiple cron jobs | DB pool/queue saturation under concurrent cron + webhook + inbox load | High | Reduce concurrent pressure (throttle non-critical minute cron jobs, lower per-run work, cap batch sizes), then reassess |
| `P2010` raw query failures | 60 occurrences, mainly cron-heavy routes (`followups`, `booking-qualification`, `response-timing`) | Same underlying DB wait-pressure surfaced through raw query paths | High | Treat as part of DB contention remediation; keep per-job budgets tight and reduce concurrent cron pressure |
| `client_login_timeout` in app flows | 37 occurrences, primarily `/` page-side operations | Connection acquisition pressure during peak contention windows | Medium | Reduce background contention first; then tune pool/concurrency if still present |
| Unique constraint violations (reconcile paths) | 38 occurrences, mostly appointment reconcile logs | Benign race conditions in concurrent reconciliation updates | Medium | Handle idempotently (upsert/do-nothing-on-conflict) and keep as secondary reliability cleanup |
| External integration noise (GHL/API/fetch) | Small counts (`API 502`=3, fetch failures=9) | Downstream/transient API failures, not primary latency driver | Medium | Add retry/backoff around affected calls; keep as secondary track |

## Why This Is Likely One Incident Cluster
- All rows share one deployment ID (`dpl_H5eNbGu6SeiTpeJtvwQsLrpFZERz`).
- Timeouts and DB contention signatures overlap in the same window (`2026-02-17 21:20–21:23 UTC`) across webhook, inbox, and cron paths.
- Query wait + transaction start failures indicate the DB side is saturated while request paths continue to accumulate work.

## Proposed Execution Order (Speed-First)
1. Deploy current timeout/perf hardening patch set (Phase 167 overlap files).
2. Enable `INBOXXIA_EMAIL_SENT_ASYNC=true` in production.
3. Temporarily reduce cron concurrency pressure (de-prioritize non-critical minutely jobs).
4. Re-sample logs for 30–60 minutes and compare signature deltas.
5. If `query_wait_timeout` persists, tune DB pool/query budget next (batch sizes/timeouts/index checks).

## Verification Targets
- `Task timed out after 60 seconds` on `/api/webhooks/email`: target near-zero recurrence.
- `Task timed out after 300 seconds` on `/api/inbox/conversations`: target near-zero recurrence.
- `P2028` / `query_wait_timeout` on inbox + response-timing: target substantial drop and no burst windows.
- Inbox API p95 server duration via `x-zrg-duration-ms`:
  - `/api/inbox/counts` <= 2000ms
  - `/api/inbox/conversations` <= 3000ms
