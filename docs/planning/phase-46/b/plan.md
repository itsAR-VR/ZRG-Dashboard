# Phase 46b — Fix EmailBison Outbound Dedupe (Send ↔ Sync ↔ Webhook)

## Focus
Ensure an EmailBison outbound reply generated by the dashboard is represented by exactly one `Message` row and is idempotent across:
- direct send paths (`sendEmailReply`, `sendEmailReplyForLead`)
- post-send sync (`syncEmailConversationHistorySystem`)
- webhook ingestion (campaign `EMAIL_SENT`, replies)

## Inputs
- Root-cause determination from Phase 46a
- Current behavior:
  - Outbound EmailBison replies are saved without `Message.emailBisonReplyId`
  - Immediate `syncEmailConversationHistorySystem(...)` may insert a second outbound message if healing fails
- Relevant files:
  - `actions/email-actions.ts`
  - `lib/emailbison-api.ts`
  - `lib/conversation-sync.ts`
  - `app/api/webhooks/email/route.ts`

## Work
1) Capture a stable provider identifier for outbound replies:
   - Inspect `lib/emailbison-api.ts:sendEmailBisonReply(...)` response payload for an outbound reply id.
   - If response contains a new reply object/id, persist it to the outbound `Message.emailBisonReplyId` at send time.
   - If no id is returned, add a deterministic follow-up lookup strategy (e.g., fetch latest “sent” reply for the lead/thread and match by subject + near-time window) and persist `emailBisonReplyId`.
2) Make sync healing deterministic and safe:
   - Update `syncEmailConversationHistorySystem(...)` to prefer matching outbound replies to an existing message using:
     - `emailBisonReplyId` (ideal once send stores it), else
     - `aiDraftId` (when sending from drafts), else
     - strong normalization match (subject + near-time window + normalized body prefix)
   - Avoid fuzzy matching that can fail when EmailBison injects previous thread text or alters formatting.
3) Confirm webhook dedupe does not reintroduce duplicates:
   - Validate `handleEmailSent(...)` remains deduped via `Message.inboxxiaScheduledEmailId`.
   - Confirm reply events (`LEAD_REPLIED`, `LEAD_INTERESTED`) remain deduped via `Message.emailBisonReplyId` and background-job `dedupeKey`.
4) Add regression coverage:
   - Add a small, deterministic unit test (or lightweight integration test) for the outbound-reply healing logic in `syncEmailConversationHistorySystem(...)`:
     - existing outbound message (no `emailBisonReplyId`) + imported EmailBison reply → updates existing row, does not insert a new one.

## Output
- PR-ready code changes that guarantee idempotent outbound EmailBison replies (single row, single send).

## Handoff
Once outbound dedupe is stable, proceed to **46c** to ensure booking-process context is consistently applied in all draft generation/regeneration paths (especially setter workflows).

## Output (Filled)
### Implemented: deterministic outbound EmailBison “heal” in sync (prevents send↔sync duplicates)

- Updated `lib/conversation-sync.ts:syncEmailConversationHistorySystem(...)` to treat **outbound** EmailBison replies differently:
  - After confirming no existing row by `emailBisonReplyId`, we attempt to heal the **send-created** outbound message row (the one we create at send time with `emailBisonReplyId = NULL`) using a high-confidence match:
    - `leadId` match
    - `channel = "email"`
    - `direction = "outbound"`
    - `source = "zrg"` (avoids campaign rows)
    - `sentAt` within ±2 minutes of the provider timestamp (config constant)
    - prefer exact `subject` match (fallback to time-window-only if needed)
  - When healed, we attach `emailBisonReplyId` to the existing row and mark it `isRead = true`.
  - We also backfill `rawHtml/rawText` onto the send-created row when they’re missing, so the “single canonical row” still has provider-rendered content available.
  - If we can’t find a safe match (or it’s ambiguous), we fall back to inserting a new message (same as before) rather than risking a false merge.
- Tightened inbound healing safety:
  - The existing “heal by content/subject” logic now only applies to `direction = "inbound"` so outbound reply ids cannot be accidentally attached to inbound messages.

### Why this fixes the FC symptom
In FC, the duplicate pattern is “send-created outbound row (no reply id) + sync-imported outbound row (has reply id) within seconds”. With this change, the sync path updates the send-created row instead of inserting a second one.

## Handoff (Filled)
Proceed to **46c** to verify/create a single shared “draft generation contract” so manual generate + regenerate (setter workflows) always include booking-process context (stages/waves, booking link rules, suggested times/questions) and consistent transcript building.
