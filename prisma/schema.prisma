// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Stores GHL API Keys per sub-account for multi-tenancy
// Each workspace is tied to a user (from Supabase Auth)
model Client {
  id            String              @id @default(uuid())
  name          String
  ghlLocationId String              @unique // Used to identify which client sent the webhook
  ghlPrivateKey String              // The generic API key for this sub-account
  emailBisonApiKey     String?
  emailBisonWorkspaceId String?     @unique // EmailBison workspace ID for webhook matching
  userId        String              // Supabase Auth user ID - ties workspace to user
  // LinkedIn/Unipile integration (per-workspace account)
  unipileAccountId     String?      // Unipile account ID for LinkedIn messaging
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  leads         Lead[]
  campaigns     Campaign[]
  smsCampaigns  SmsCampaign[]
  emailCampaigns EmailCampaign[]
  settings      WorkspaceSettings?  // One-to-one relation with settings
  followUpSequences FollowUpSequence[]  // Follow-up sequence templates
  calendarLinks CalendarLink[]      // Multiple calendar links for availability
  availabilityCache WorkspaceAvailabilityCache?
  offeredSlots   WorkspaceOfferedSlot[]
  aiInteractions AIInteraction[]

  @@index([userId])
}

// Workspace-specific settings (AI personality, automation, etc.)
model WorkspaceSettings {
  id                   String   @id @default(uuid())
  clientId             String   @unique // Links to workspace
  client               Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  // AI Personality Settings
  aiPersonaName        String?
  aiTone               String?  @default("friendly-professional")
  aiGreeting           String?  // Default greeting for Email channel
  aiSmsGreeting        String?  // Default greeting for SMS channel (falls back to aiGreeting if null)
  aiSignature          String?  @db.Text
  aiGoals              String?  @db.Text
  // AI Context Fields (for better AI responses)
  serviceDescription      String?  @db.Text  // Business/service description for AI context
  qualificationQuestions  String?  @db.Text  // JSON array of qualification questions
  // Company/Outreach Context
  companyName             String?             // Company name for {company} variable in templates
  targetResult            String?  @db.Text   // Outcome/result for {result} variable (e.g., "growing your client base")
  // Automation Rules
  autoApproveMeetings  Boolean  @default(true)
  flagUncertainReplies Boolean  @default(true)
  pauseForOOO          Boolean  @default(true)
  autoBlacklist        Boolean  @default(true)
  autoFollowUpsOnReply Boolean  @default(false) // When true, auto-enable follow-ups for leads after a positive inbound EMAIL reply.
  airtableMode         Boolean  @default(false) // When true, email is handled externally (Airtable/n8n); follow-up sequences should be SMS/LinkedIn only.
  // Notification Settings
  emailDigest          Boolean  @default(true)
  slackAlerts          Boolean  @default(true)
  // Schedule Settings
  timezone             String?
  workStartTime        String?  @default("09:00")
  workEndTime          String?  @default("17:00")
  // Calendar Settings
  calendarSlotsToShow    Int?     @default(3)   // Number of availability slots to show
  calendarLookAheadDays  Int?     @default(28)  // Days to look ahead for availability
  // GHL Meeting Booking Settings
  ghlDefaultCalendarId   String?              // Selected GHL calendar for booking appointments
  ghlAssignedUserId      String?              // Default team member assigned to appointments
  autoBookMeetings       Boolean  @default(false)  // Workspace-level auto-book toggle
  meetingDurationMinutes Int      @default(30)     // Default meeting duration in minutes
  meetingTitle           String?  @default("Intro to {companyName}")  // Title template for appointments
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  // Relations
  knowledgeAssets      KnowledgeAsset[]
}

// GHL Workflows/Campaigns synced from the API
model Campaign {
  id            String   @id @default(uuid())
  ghlWorkflowId String   @unique
  name          String
  status        String   @default("active") // active, inactive, draft
  clientId      String
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  leads         Lead[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([clientId])
}

// SMS sub-client attribution (scoped per workspace/client)
model SmsCampaign {
  id             String   @id @default(uuid())
  clientId       String
  client         Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name           String
  nameNormalized String
  leads          Lead[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([clientId, nameNormalized])
  @@index([clientId])
}

// Lead/Contact record - unified across SMS, Email, and LinkedIn channels
model Lead {
  id           String        @id @default(uuid())
  // External system IDs (all optional for multi-channel support)
  ghlContactId     String?   @unique // GoHighLevel contact ID (for SMS)
  emailBisonLeadId String?   // Inboxxia/EmailBison lead ID (for Email)
  linkedinId       String?   // Unipile LinkedIn member ID (populated after connection)
  linkedinUrl      String?   // LinkedIn profile URL (normalized format)
  // Contact information
  firstName    String?
  lastName     String?
  email        String?
  phone        String?       // Stored normalized (digits only)
  timezone     String?       // Lead's timezone for availability slot formatting
  // Company information (from EmailBison custom variables)
  companyName      String?   // Lead's actual company name
  companyWebsite   String?   // Company website URL
  companyState     String?   // Company state/region
  // Status and sentiment
  status       String        @default("new")
  sentimentTag String?       // e.g., 'Meeting Requested', 'Not Interested', etc.
  snoozedUntil DateTime?     // When snoozed, hide from inbox until this date
  // Enrichment tracking (for Clay/EmailBison/signature extraction)
  enrichmentStatus   String?   // 'pending' | 'enriched' | 'not_found' | 'not_needed' | 'failed'
  enrichmentSource   String?   // 'emailbison' | 'clay' | 'signature' | 'message_content' | null
  enrichedAt         DateTime? // When enrichment was last completed
  enrichmentRetryCount  Int       @default(0)  // Number of Clay enrichment retry attempts
  enrichmentLastRetry   DateTime?              // When the last retry was attempted
  // Automation settings
  autoReplyEnabled Boolean   @default(false)
  autoFollowUpEnabled Boolean @default(false)
  // Meeting booking settings
  autoBookMeetingsEnabled Boolean   @default(true)   // Lead-level auto-book toggle
  offeredSlots            String?   @db.Text         // JSON array of offered time slots
  bookedSlot              String?                    // ISO datetime of booked slot (for filtering availability)
  ghlAppointmentId        String?                    // GHL appointment ID after booking
  appointmentBookedAt     DateTime?                  // When the appointment was booked
  // Workspace and campaign associations
  clientId     String
  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  campaignId   String?       // Optional link to SMS campaign
  campaign     Campaign?     @relation(fields: [campaignId], references: [id])
  smsCampaignId String?      // Optional link to SMS sub-client
  smsCampaign   SmsCampaign? @relation(fields: [smsCampaignId], references: [id])
  emailCampaignId String?    // Optional link to EmailBison campaign
  emailCampaign   EmailCampaign? @relation(fields: [emailCampaignId], references: [id])
  senderAccountId String?    // EmailBison sender email account id
  // Calendar preferences
  preferredCalendarLinkId String?        // Optional per-lead calendar override
  preferredCalendarLink   CalendarLink?  @relation(fields: [preferredCalendarLinkId], references: [id])
  // Relations
  messages          Message[]
  followUps         FollowUpTask[]
  followUpInstances FollowUpInstance[]  // Active follow-up sequences for this lead
  aiDrafts          AIDraft[]
  aiInteractions    AIInteraction[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([clientId])
  @@index([campaignId])
  @@index([smsCampaignId])
  @@index([emailCampaignId])
  @@index([emailBisonLeadId])
  @@index([sentimentTag])
  @@index([email])          // For cross-channel matching
  @@index([phone])          // For cross-channel matching
  @@index([linkedinUrl])    // For LinkedIn matching
  @@index([enrichmentStatus]) // For batch enrichment queries
  @@index([preferredCalendarLinkId])
  
  // Composite indexes for CRM/Inbox cursor pagination and filtering
  @@index([clientId, status])                    // CRM status filter
  @@index([clientId, updatedAt(sort: Desc)])     // CRM/Inbox default sort
  @@index([clientId, status, updatedAt(sort: Desc)]) // Combined filter + sort
  @@index([clientId, sentimentTag, updatedAt(sort: Desc)]) // Sentiment filter + sort
  @@index([clientId, firstName])                 // Name search
  @@index([clientId, lastName])                  // Name search
}

// Conversation messages across all channels (SMS, Email, LinkedIn)
model Message {
  id        String   @id @default(uuid())
  // External system IDs for deduplication
  ghlId     String?  @unique // GoHighLevel Message ID (SMS)
  emailBisonReplyId String?  @unique // EmailBison reply ID (Email)
  inboxxiaScheduledEmailId String? @unique // Inboxxia scheduled email ID for EMAIL_SENT dedup
  // Channel and source
  channel   String   @default("sms") // 'sms' | 'email' | 'linkedin'
  source    String   @default("zrg") // 'zrg' | 'inboxxia_campaign' - origin of the message
  // Message content
  body      String   @db.Text
  rawText   String?  @db.Text // Original text body (if provided)
  rawHtml   String?  @db.Text // Original HTML body (if provided)
  subject   String?           // Email subject line
  cc        String[] @default([])
  bcc       String[] @default([])
  // Status
  isRead    Boolean  @default(false)
  direction String   // 'inbound' or 'outbound'
  // Lead association
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  // Timestamps
  sentAt    DateTime @default(now()) // Actual timestamp when message was sent/received
  createdAt DateTime @default(now()) // When record was created in our database

  @@index([leadId])
  @@index([sentAt(sort: Desc)])
  @@index([source])
  @@index([channel])         // For filtering messages by channel
}

// Follow-up tasks for leads (individual scheduled tasks)
model FollowUpTask {
  id               String    @id @default(uuid())
  leadId           String
  lead             Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type             String    // 'email', 'call', 'sms', 'linkedin', 'ai_voice'
  dueDate          DateTime
  status           String    @default("pending") // pending, completed, skipped, cancelled
  suggestedMessage String?   @db.Text
  subject          String?   // For email tasks
  // Legacy fields (for backward compatibility)
  sequenceStep     Int?      // Current step in campaign sequence
  totalSteps       Int?      // Total steps in campaign
  campaignName     String?
  // Link to follow-up sequence system (optional)
  instanceId       String?   // Link to FollowUpInstance if part of a sequence
  stepOrder        Int?      // Which step in the sequence this task represents
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([leadId])
  @@index([dueDate])
  @@index([status])
  @@index([instanceId])
}

// AI-generated draft messages pending approval
model AIDraft {
  id        String   @id @default(uuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  channel   String   @default("sms") // sms | email
  status    String   @default("pending") // pending, approved, rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([channel])
  @@index([status])
}

// AI usage telemetry (admin-only observability)
model AIInteraction {
  id           String   @id @default(uuid())
  clientId     String
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  leadId       String?
  lead         Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  featureId    String   // Stable feature key (e.g. "sentiment.classify")
  promptKey    String?  // Optional prompt registry key/version
  model        String
  apiType      String   // "responses" | "chat_completions"
  inputTokens  Int?
  outputTokens Int?
  reasoningTokens Int?
  totalTokens  Int?
  latencyMs    Int?
  status       String   @default("success") // success | error
  errorMessage String?  @db.Text
  createdAt    DateTime @default(now())

  @@index([clientId])
  @@index([leadId])
  @@index([featureId])
  @@index([model])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([clientId, createdAt(sort: Desc)])
  @@index([clientId, featureId, createdAt(sort: Desc)])
}

// EmailBison campaigns synced per client
model EmailCampaign {
  id             String   @id @default(uuid())
  bisonCampaignId String
  name           String
  clientId       String
  client         Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  leads          Lead[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([clientId, bisonCampaignId])
  @@index([clientId])
}

// Knowledge assets for AI context (uploaded files, text snippets)
model KnowledgeAsset {
  id                  String   @id @default(uuid())
  workspaceSettingsId String
  workspaceSettings   WorkspaceSettings @relation(fields: [workspaceSettingsId], references: [id], onDelete: Cascade)
  name                String              // Display name for the asset
  type                String              // 'file' | 'text' | 'url'
  fileUrl             String?             // Supabase Storage URL (for files)
  textContent         String?  @db.Text   // Extracted or direct text content
  originalFileName    String?             // Original file name if uploaded
  mimeType            String?             // File MIME type
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([workspaceSettingsId])
}

// =============================================================================
// Follow-Up Sequence System
// =============================================================================

// Client-level follow-up sequence template
model FollowUpSequence {
  id          String   @id @default(uuid())
  name        String
  description String?
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  isActive    Boolean  @default(true)
  triggerOn   String   @default("no_response")  // 'no_response' | 'meeting_selected' | 'manual'
  steps       FollowUpStep[]
  instances   FollowUpInstance[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clientId])
  @@index([isActive])
}

// Individual step in a follow-up sequence
model FollowUpStep {
  id               String   @id @default(uuid())
  sequenceId       String
  sequence         FollowUpSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  stepOrder        Int               // Order within the sequence (1, 2, 3...)
  dayOffset        Int               // Days after sequence start (0 = same day, 2 = Day 2, etc.)
  channel          String            // 'email' | 'sms' | 'linkedin' | 'ai_voice'
  messageTemplate  String?  @db.Text // Template with {variables} like {firstName}, {company}
  subject          String?           // For email subject lines
  condition        String?  @db.Text // JSON condition: { "type": "phone_provided" | "linkedin_connected" | "no_response" }
  requiresApproval Boolean  @default(false)
  fallbackStepId   String?           // If condition fails, skip to this step order

  @@unique([sequenceId, stepOrder])
  @@index([sequenceId])
}

// Per-lead follow-up sequence instance (tracks progress through a sequence)
model FollowUpInstance {
  id             String   @id @default(uuid())
  leadId         String
  lead           Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  sequenceId     String
  sequence       FollowUpSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  currentStep    Int      @default(0)    // Current step order (0 = not started yet)
  status         String   @default("active")  // 'active' | 'paused' | 'completed' | 'cancelled'
  pausedReason   String?                  // Reason for pause (e.g., "lead_replied", "manual")
  startedAt      DateTime @default(now())
  lastStepAt     DateTime?                // When the last step was executed
  nextStepDue    DateTime?                // When the next step should run
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([leadId, sequenceId])
  @@index([leadId])
  @@index([sequenceId])
  @@index([status])
  @@index([nextStepDue])
}

// =============================================================================
// Calendar Integration
// =============================================================================

// Calendar links for availability (multiple per workspace)
model CalendarLink {
  id         String   @id @default(uuid())
  clientId   String
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name       String              // Display name (e.g., "Sales Calendar", "Demo Calls")
  url        String              // Full calendar URL (calendly.com/user/meeting)
  type       String              // 'calendly' | 'hubspot' | 'ghl' | 'unknown'
  isDefault  Boolean  @default(false)  // Default calendar for this workspace
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  // Leads that prefer this specific calendar
  leads      Lead[]
  availabilityCaches WorkspaceAvailabilityCache[]

  @@index([clientId])
  @@index([isDefault])
}

// Per-workspace cache of live availability from the default CalendarLink
// Refreshed by cron every 10 minutes (and on-demand when stale).
model WorkspaceAvailabilityCache {
  id                  String      @id @default(uuid())
  clientId            String      @unique
  client              Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  calendarLinkId      String?
  calendarLink        CalendarLink? @relation(fields: [calendarLinkId], references: [id], onDelete: SetNull)
  calendarType        String      // 'calendly' | 'hubspot' | 'ghl' | 'unknown'
  calendarUrl         String
  slotDurationMinutes Int         @default(30)
  rangeStart          DateTime
  rangeEnd            DateTime
  slotsUtc            Json        // JSON array of ISO datetimes in UTC
  providerMeta        Json?
  fetchedAt           DateTime
  staleAt             DateTime
  lastError           String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([clientId])
  @@index([staleAt])
  @@index([calendarLinkId])
}

// Tracks how often specific availability slots have been offered to leads (soft distribution signal).
// Used to spread suggested times across the next few days before reusing the same slot.
model WorkspaceOfferedSlot {
  id            String   @id @default(uuid())
  clientId      String
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  slotUtc       DateTime
  offeredCount  Int      @default(0)
  lastOfferedAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([clientId, slotUtc])
  @@index([clientId])
  @@index([slotUtc])
  @@index([clientId, slotUtc])
}
